// ==UserScript==
// @name         å”å”ä¸çº¦è‡ªåŠ¨é…å¯¹åŠ©æ‰‹(äº¬æ´¥å†€)
// @namespace    wwbnq
// @version      2.9
// @description  é’ˆå¯¹Greasemonkeyä¼˜åŒ–çš„è‡ªåŠ¨é…å¯¹åŠ©æ‰‹
// @author       WWBNQ
// @match        https://www.shushubuyue.net/*
// @match        https://www.shushubuyue.com/*
// @match        http://www.shushubuyue.net/*
// @match        http://www.shushubuyue.com/*
// @grant        GM.setValue
// @grant        GM.getValue
// @grant        window.close
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const CONFIG = {
        CHECK_INTERVAL: 500 + Math.random() * 200,  // 500-700ms
        MIN_DELAY: 400,          // 400ms
        MAX_DELAY: 1000,         // 1000ms
        LEAVE_MIN_DELAY: 500,    // 500ms
        LEAVE_MAX_DELAY: 1500,   // 1500ms
        CHAT_MIN_DELAY: 500,     // 500ms
        CHAT_MAX_DELAY: 1200,    // 1200ms
        TYPE_SPEED: {
            MIN: 50,             // 50ms/å­—
            MAX: 150             // 150ms/å­—
        }
    };

    // å¯è‡ªå®šä¹‰çš„ç­›é€‰çœä»½ï¼ˆé¡µé¢æ–‡æœ¬éœ€ä¸ºè¿™äº›å…¨ç§°ï¼‰
    // ä¾‹å¦‚ï¼š['åŒ—äº¬','æ²³åŒ—','å¤©æ´¥']ï¼Œå¯è‡ªè¡Œå¢åˆ 
    const REGION_KEYWORDS = ["åŒ—äº¬", "å¤©æ´¥", "æ²³åŒ—"]; // ç”¨æˆ·å¯åœ¨æ­¤è¡Œè‡ªå®šä¹‰

    // å…¨ç§°åˆ°çŸ­æ ‡æ˜ å°„ï¼Œç”¨äºé¢æ¿å±•ç¤ºï¼ˆä¸å½±å“å†…éƒ¨åŒ¹é…ï¼‰
    const REGION_SHORT_MAP = {
        "åŒ—äº¬": "äº¬",
        "å¤©æ´¥": "æ´¥",
        "æ²³åŒ—": "å†€",
        "ä¸Šæµ·": "æ²ª",
        "é‡åº†": "æ¸",
        "å†…è’™å¤": "è’™",
        "é»‘é¾™æ±Ÿ": "é»‘",
        "å‰æ—": "å‰",
        "è¾½å®": "è¾½",
        "å±±ä¸œ": "é²",
        "å±±è¥¿": "æ™‹",
        "é™•è¥¿": "é™•",
        "ç”˜è‚ƒ": "ç”˜",
        "é’æµ·": "é’",
        "æ²³å—": "è±«",
        "æ±Ÿè‹": "è‹",
        "æµ™æ±Ÿ": "æµ™",
        "å®‰å¾½": "çš–",
        "æ±Ÿè¥¿": "èµ£",
        "ç¦å»º": "é—½",
        "å¹¿ä¸œ": "ç²¤",
        "å¹¿è¥¿": "æ¡‚",
        "æµ·å—": "ç¼",
        "å››å·": "å·",
        "è´µå·": "é»”",
        "äº‘å—": "æ»‡",
        "è¥¿è—": "è—",
        "å®å¤": "å®",
        "æ–°ç–†": "æ–°",
        "æ¹–åŒ—": "é„‚",
        "æ¹–å—": "æ¹˜",
        "æ²³å—": "è±«"
    };

    const REGION_STORAGE_KEY = 'shushu_region_keywords';

    function loadRegionKeywords() {
        try {
            const stored = localStorage.getItem(REGION_STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    // ä¸é»˜è®¤åˆ—è¡¨åˆå¹¶ï¼Œé¿å…æ—§ç‰ˆæœ¬è¦†ç›–å¯¼è‡´åªå‰©å®šä½çœä»½
                    const merged = Array.from(new Set([ ...REGION_KEYWORDS, ...parsed ]));
                    return merged;
                }
            }
        } catch (e) {}
        return REGION_KEYWORDS.slice();
    }

    function saveRegionKeywords(regions) {
        try {
            localStorage.setItem(REGION_STORAGE_KEY, JSON.stringify(regions));
        } catch (e) {}
    }

    let CURRENT_REGION_KEYWORDS = loadRegionKeywords();

    function getRegionShortDisplay() {
        if (!isRegionFilterEnabled) return "ä¸é™";
        const shorts = CURRENT_REGION_KEYWORDS.map(name => REGION_SHORT_MAP[name] || name).join('/');
        return shorts || 'ä¸é™';
    }

    function normalizeProvinceName(name) {
        if (!name) return '';
        let n = name.trim();
        const specialMap = {
            'å†…è’™å¤è‡ªæ²»åŒº': 'å†…è’™å¤',
            'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'å¹¿è¥¿',
            'å®å¤å›æ—è‡ªæ²»åŒº': 'å®å¤',
            'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'æ–°ç–†',
            'è¥¿è—è‡ªæ²»åŒº': 'è¥¿è—',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'é¦™æ¸¯',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'æ¾³é—¨'
        };
        if (specialMap[n]) return specialMap[n];
        n = n.replace(/(çœ|å¸‚|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº)$/g, '');
        return n;
    }

    async function setRegionFromLocation(lat, lon) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=5&addressdetails=1`;
            const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
            const data = await resp.json();
            const addr = data && data.address ? data.address : {};
            const raw = addr.state || addr.county || addr.region || addr.province || '';
            const province = normalizeProvinceName(raw);
            if (province) {
                const merged = Array.from(new Set([ ...REGION_KEYWORDS, ...(CURRENT_REGION_KEYWORDS || []), province ]));
                CURRENT_REGION_KEYWORDS = merged;
                saveRegionKeywords(CURRENT_REGION_KEYWORDS);
                console.log('å®šä½åˆ°çœä»½å¹¶å·²åŠ å…¥ç­›é€‰:', province, 'å½“å‰ç­›é€‰é›†:', CURRENT_REGION_KEYWORDS);
                return province;
            }
        } catch (e) {
            console.error('å®šä½æˆ–åæŸ¥å¤±è´¥:', e);
        }
        return null;
    }

    const GREETINGS = [
        "hiï¼Œå®å®~",
        "ä½ å¥½å‘€ï¼Œå®å®",
        "helloï¼Œå®å®",
        "ä½ å¥½ï¼Œå®å®",
        "å—¨ï¼Œå®å®",
        "heyï¼Œå®å®",
       ];

    const TIME_GREETINGS = [
        { start: 5, end: 11, greetings: ["æ—©ä¸Šå¥½"] },
        { start: 11, end: 14, greetings: ["ä¸­åˆå¥½"] },
        { start: 14, end: 18, greetings: ["ä¸‹åˆå¥½"] },
        { start: 18, end: 24, greetings: ["æ™šä¸Šå¥½"] },
        { start: 0, end: 5, greetings: ["å¤œæ·±äº†ï¼ŒèŠä¼šå§"] }
    ];

    let isLocked = false;
    let isScriptEnabled = true;
    let matchCount = 0;
    let startTime = Date.now();
    let isInLeaveProcess = false;
    let lastActionTime = Date.now();
    let hasGreeted = false;
    let lastSessionId = null;
    let hasSecondReplied = false;
    // é˜²é‡å¤é—®å€™ï¼šè¿›è¡Œä¸­æ ‡è®°ã€ä¸Šæ¬¡ä¼šè¯æ ‡è¯†ä¸æ—¶é—´æˆ³èŠ‚æµ
    let isGreetingInProgress = false;
    let lastGreetingSessionId = null;
    let lastGreetingAt = 0;
    let isRegionFilterEnabled = (function() {
        try {
            const saved = localStorage.getItem("shushu_region_filter_enabled");
            if (saved === null) return true; // é»˜è®¤å¼€å¯
            return saved === "true";
        } catch (e) {
            return true;
        }
    })();

    // ç»Ÿè®¡ï¼šå‘ç°å¥³ç”Ÿæ¬¡æ•° ä¸ å› åœ°åŒºç­›é€‰è¢«è·³è¿‡æ¬¡æ•°
    let statsFoundFemale = 0;
    let statsSkippedByRegion = 0;
    let lastCountedFemaleSessionId = null;
    let lastSkippedByRegionSessionId = null;
    let isProgrammaticLeaveClick = false;

    function canLeaveNow() {
        // çº¯æ‰‹åŠ¨ä¼˜å…ˆï¼šå§‹ç»ˆæ‹¦æˆªç”¨æˆ·æ‰‹ç‚¹ï¼ˆä»…ç¨‹åºç™½åå•æ”¾è¡Œï¼‰
        return false;
    }

    function setupLeaveGuard() {
        try {
            const guardedSelectors = [
                'a.button-link.leave',
                'a.button-link.chat-control',
                'a.leave',
                '.chat-control',
                'span.chat-control',
                "a[class*='leave']",
                "a[class*='chat-control']"
            ].join(',');

            document.addEventListener('click', function(e) {
                const target = e.target;
                if (!target) return;
                const btn = target.closest(guardedSelectors);
                if (!btn) return;

                if (isProgrammaticLeaveClick) {
                    // æ”¾è¡Œç¨‹åºè§¦å‘çš„ç‚¹å‡»
                    return;
                }

                if (!canLeaveNow()) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.warn('å·²æ‹¦æˆªç¦»å¼€/é‡æ–°å¼€å§‹ç‚¹å‡»ï¼Œé¿å…è¯¯é€€');
                }
            }, true);
        } catch (err) {
            console.error('leave guard å®‰è£…å¤±è´¥:', err);
        }
    }

    function getRandomDelay(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min) + Math.random() * 100;
    }

    function getRandomGreeting() {
        const hour = new Date().getHours();
        let timeGreetings = [];
        for (const tg of TIME_GREETINGS) {
            if (hour >= tg.start && hour < tg.end) {
                timeGreetings = tg.greetings;
                break;
            }
        }
        // 50%æ¦‚ç‡ç”¨æ—¶é—´é—®å€™ï¼Œå¦åˆ™ç”¨åŸæœ‰é—®å€™
        if (timeGreetings.length && Math.random() < 0.5) {
            return timeGreetings[Math.floor(Math.random() * timeGreetings.length)];
        }
        return GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
    }

    const SECOND_REPLIES = [
        "å®å®å¤šå¤§äº†",
        "å®å®å–œæ¬¢è¢«è°ƒå—ï¼Ÿ",
    ];

    function getRandomSecondReply() {
        return SECOND_REPLIES[Math.floor(Math.random() * SECOND_REPLIES.length)];
    }

    async function simulateTyping(msgInput, text) {
        msgInput.focus();
        const originalText = text;
        for(let i = 0; i < text.length; i++) {
            msgInput.value = text.substring(0, i + 1);
            msgInput.dispatchEvent(new Event('input'));
            await new Promise(r => setTimeout(r,
                getRandomDelay(CONFIG.TYPE_SPEED.MIN, CONFIG.TYPE_SPEED.MAX)));
        }
        return msgInput.value === originalText;
    }

    function findLeaveButton() {
        const selectors = [
            "a.button-link.leave",
            "a.button-link.chat-control",
            "a.leave",
            ".chat-control",
            "span.chat-control",
            "a[class*='leave']",
            "a[class*='chat-control']"
        ];

        for (const selector of selectors) {
            const button = document.querySelector(selector);
            if (button) return button;
        }
        return null;
    }

function hasNewSystemMessage() {
        try {
            // ä¼˜å…ˆæ£€æŸ¥æœ€è¿‘çš„ç³»ç»Ÿæ¶ˆæ¯æ°”æ³¡ï¼Œé¿å…å› å…¨é¡µæ®‹ç•™æ–‡æœ¬è¯¯åˆ¤
            const systemCandidates = Array.from(document.querySelectorAll('.message.system, .system, .chat-system, .system-message'));
            for (let i = systemCandidates.length - 1; i >= 0 && i >= systemCandidates.length - 3; i--) {
                const text = (systemCandidates[i] && systemCandidates[i].innerText) || '';
                if (text.includes("å¯¹æ–¹ç¦»å¼€äº†")) return true;
            }

            // å…¶æ¬¡å°è¯•ä»èŠå¤©åŒºåŸŸçš„æœ€åä¸€é¡¹åˆ¤æ–­
            const chatArea = document.querySelector('.messages, .chat, .chat-area');
            if (chatArea && chatArea.lastElementChild) {
                const last = chatArea.lastElementChild;
                const t = (last && last.innerText) || '';
                if (t.includes("å¯¹æ–¹ç¦»å¼€äº†")) return true;
            }

            // å…œåº•ï¼šå…¨é¡µæ–‡æœ¬åŒ¹é…ï¼ˆå¯èƒ½äº§ç”Ÿè¯¯åˆ¤ï¼‰
            const pageText = document.body ? document.body.innerText : '';
            return pageText.includes("å¯¹æ–¹ç¦»å¼€äº†");
        } catch (error) {
            console.error("ç³»ç»Ÿæ¶ˆæ¯æ£€æŸ¥å‡ºé”™:", error);
            return false;
        }
}

    function hasLeaveModal() {
        return !!document.querySelector(".actions-modal");
    }

    async function handleLeaveModal() {
        const confirmButton = document.querySelector(".actions-modal-button-bold.color-danger");
        if (confirmButton) {
            await new Promise(r => setTimeout(r, getRandomDelay(200, 400)));
            confirmButton.click();
            await new Promise(r => setTimeout(r, CONFIG.LEAVE_MAX_DELAY));
        }
    }

    function createStatsDisplay() {
        const statsDiv = document.createElement('div');
        statsDiv.style.cssText = `
            position: fixed;
            top: 50px;
            left: 10px;
            background: linear-gradient(145deg, rgba(0,0,0,0.2), rgba(40,40,40,0.3));
            color: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 9999;
            font-family: 'Arial', sans-serif;
            box-shadow: 0 3px 10px rgba(0,0,0,.08);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 150px;
            backdrop-filter: blur(2px);
            transition: all 0.3s ease;
            user-select: none;
            opacity: 0.85;
        `;

        const toggleButton = document.createElement('button');
        toggleButton.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: ${isScriptEnabled ? '#4CAF50' : '#f44336'};
            border: none;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.8;
        `;

        toggleButton.addEventListener('click', () => {
            isScriptEnabled = !isScriptEnabled;
            toggleButton.style.background = isScriptEnabled ? '#4CAF50' : '#f44336';
        });

        // åœ°åŒºç­›é€‰å¼€å…³
        const regionToggle = document.createElement('button');
        regionToggle.style.cssText = `
            position: absolute;
            top: 10px;
            left: 10px;
            background: ${isRegionFilterEnabled ? '#2196F3' : '#607D8B'};
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 1px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.9;
        `;
        regionToggle.textContent = isRegionFilterEnabled ? 'äº¬æ´¥å†€:å¼€' : 'äº¬æ´¥å†€:å…³';
        regionToggle.addEventListener('click', () => {
            isRegionFilterEnabled = !isRegionFilterEnabled;
            localStorage.setItem('shushu_region_filter_enabled', String(isRegionFilterEnabled));
            regionToggle.style.background = isRegionFilterEnabled ? '#2196F3' : '#607D8B';
            regionToggle.textContent = isRegionFilterEnabled ? 'äº¬æ´¥å†€:å¼€' : 'äº¬æ´¥å†€:å…³';
            // ç«‹å³åˆ·æ–°å±•ç¤º
            if (statsDiv._contentDiv) updateStatsDisplay(statsDiv);
        });

        // å®šä½æŒ‰é’®ï¼šè‡ªåŠ¨è®¾ç½®æœ¬åœ°çœä»½ä¸ºç­›é€‰
        const locateButton = document.createElement('button');
        locateButton.style.cssText = `
            position: absolute;
            top: 40px;
            left: 10px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 1px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.9;
        `;
        locateButton.textContent = 'å®šä½:æœ¬åœ°';
        locateButton.addEventListener('click', async () => {
            try {
                if (!navigator.geolocation) {
                    alert('æ­¤æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
                    return;
                }
                locateButton.disabled = true;
                locateButton.textContent = 'å®šä½ä¸­...';
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    const province = await setRegionFromLocation(latitude, longitude);
                    if (province) {
                        isRegionFilterEnabled = true;
                        localStorage.setItem('shushu_region_filter_enabled', 'true');
                        regionToggle.style.background = '#2196F3';
                        regionToggle.textContent = 'äº¬æ´¥å†€:å¼€';
                        // åˆ·æ–°æ˜¾ç¤ºï¼Œæ˜¾ç¤ºä¸º ç´¯åŠ åçš„çŸ­æ ‡é›†
                        if (statsDiv._contentDiv) updateStatsDisplay(statsDiv);
                        alert('å·²å°†æœ¬åœ°çœä»½åŠ å…¥ç­›é€‰ï¼š' + province + 'ï¼ˆä¸å½“å‰åˆ—è¡¨ç´¯åŠ ï¼‰');
                    } else {
                        alert('æœªèƒ½è¯†åˆ«çœä»½');
                    }
                    locateButton.disabled = false;
                    locateButton.textContent = 'å®šä½:æœ¬åœ°';
                }, (err) => {
                    alert('å®šä½å¤±è´¥ï¼š' + err.message);
                    locateButton.disabled = false;
                    locateButton.textContent = 'å®šä½:æœ¬åœ°';
                }, { enableHighAccuracy: true, timeout: 10000 });
            } catch (e) {
                alert('å®šä½å¼‚å¸¸');
                locateButton.disabled = false;
                locateButton.textContent = 'å®šä½:æœ¬åœ°';
            }
        });

        statsDiv.appendChild(toggleButton);
        statsDiv.appendChild(regionToggle);
        statsDiv.appendChild(locateButton);

        // æ‰‹åŠ¨é€€å‡ºæŒ‰é’®ï¼ˆå®‰å…¨è§¦å‘ç¦»å¼€æµç¨‹ï¼‰
        const manualExitButton = document.createElement('button');
        manualExitButton.style.cssText = `
            position: absolute;
            top: 40px;
            left: 90px;
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 1px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.9;
        `;
        manualExitButton.textContent = 'é€€å‡º';
        manualExitButton.addEventListener('click', async () => {
            if (manualExitButton.disabled) return;
            manualExitButton.disabled = true;
            try {
                isInLeaveProcess = true;
                const leaveButton = findLeaveButton();
                if (leaveButton) {
                    isProgrammaticLeaveClick = true;
                    leaveButton.click();
                    isProgrammaticLeaveClick = false;
                    await new Promise(r => setTimeout(r, CONFIG.LEAVE_MIN_DELAY));
                }
                await handleLeaveModal();
                await startNewChat();
            } catch(e) {
                console.error('æ‰‹åŠ¨é€€å‡ºå¤±è´¥', e);
            } finally {
                isInLeaveProcess = false;
                manualExitButton.disabled = false;
            }
        });
        statsDiv.appendChild(manualExitButton);
        
        // ç”¨äºæ‰¿è½½åŠ¨æ€ç»Ÿè®¡å†…å®¹çš„å®¹å™¨ï¼Œé¿å…åˆ·æ–°æ—¶ç§»é™¤æŒ‰é’®
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = `margin-top: 56px;`;
        statsDiv.appendChild(contentDiv);
        // å­˜å‚¨å¼•ç”¨ï¼Œä¾› updateStatsDisplay ä½¿ç”¨
        statsDiv._contentDiv = contentDiv;
        document.body.appendChild(statsDiv);
        return statsDiv;
    }

    function updateStatsDisplay(statsDiv) {
        const runTime = Math.floor((Date.now() - startTime) / 60000);
        const hours = Math.floor(runTime / 60);
        const minutes = runTime % 60;
        const timeStr = hours > 0 ? `${hours}æ—¶${minutes}åˆ†` : `${minutes}åˆ†`;

        const target = statsDiv._contentDiv || statsDiv; // å…¼å®¹æ—§ç»“æ„
        target.innerHTML = `
            <div style=\"margin-bottom: 6px; line-height: 1.2;\">
                <span style=\"display:inline-block;width:16px;text-align:center;font-size:14px;color:#2196F3;\">ğŸ“</span>
                ç­›é€‰: ${getRegionShortDisplay()}
            </div>
            <div style=\"margin-bottom: 6px; font-size: 14px; color: rgba(255,255,255,0.85); line-height: 1.2;\">
                <span style=\"display:inline-block;width:16px;text-align:center;\">ğŸ‘©</span>
                å¥³ç”Ÿ: ${matchCount}ï¼Œç­›æ‰: ${statsSkippedByRegion}
            </div>
            <div style=\"font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.2;\">
                <span style=\"display:inline-block;width:16px;text-align:center;\">ğŸ•’</span>
                æ—¶é—´: ${timeStr}
            </div>
        `;
    }

    async function handlePartnerLeft() {
        if (isInLeaveProcess) return;

        console.log("æ£€æµ‹åˆ°å¯¹æ–¹ç¦»å¼€ï¼Œå‡†å¤‡é‡æ–°å¼€å§‹");
        isLocked = false;
        isInLeaveProcess = true;

        try {
            await new Promise(r => setTimeout(r, 500));

            if (hasLeaveModal()) {
                await handleLeaveModal();
            }

            const leaveButton = findLeaveButton();
            if (leaveButton) {
                await new Promise(r => setTimeout(r, getRandomDelay(200, 400)));
                isProgrammaticLeaveClick = true;
                leaveButton.click();
                isProgrammaticLeaveClick = false;
                await new Promise(r => setTimeout(r, CONFIG.LEAVE_MIN_DELAY));
            }

            await startNewChat();

        } catch (error) {
            console.error("ç¦»å¼€å¤„ç†å‡ºé”™:", error);
        } finally {
            isLocked = false;
            isInLeaveProcess = false;
            console.log("é‡æ–°å¼€å§‹å®Œæˆ");
        }
    }

    async function handleMaleMatch() {
        if (isInLeaveProcess) return;

        try {
            isInLeaveProcess = true;

            // ä»…å½“æ˜¯æˆ‘ä»¬ä¸»åŠ¨çš„ç¦»å¼€æµç¨‹ä¸­ï¼Œæ‰å¤„ç†ç¦»å¼€å¼¹çª—å¹¶é‡æ–°å¼€å§‹
            if (hasLeaveModal()) {
                if (isInLeaveProcess) {
                    await handleLeaveModal();
                    await startNewChat();
                }
                return;
            }

            const leaveButton = findLeaveButton();
            if (leaveButton) {
                await new Promise(r => setTimeout(r, getRandomDelay(200, 400)));
                isProgrammaticLeaveClick = true;
                leaveButton.click();
                isProgrammaticLeaveClick = false;
                await new Promise(r => setTimeout(r, CONFIG.LEAVE_MIN_DELAY));
            }

            await handleLeaveModal();
            await startNewChat();

        } catch (error) {
            console.error("ç”·ç”ŸåŒ¹é…å¤„ç†å‡ºé”™:", error);
        } finally {
            isLocked = false;
            isInLeaveProcess = false;
        }
    }

    async function handleFemaleMatch() {
        if (isLocked || isInLeaveProcess) {
            console.log("å·²é”å®šæˆ–æ­£åœ¨ç¦»å¼€è¿‡ç¨‹ä¸­");
            return;
        }

        try {
            if (hasNewSystemMessage()) {
                console.log("æ£€æµ‹åˆ°å¯¹æ–¹ç¦»å¼€æ¶ˆæ¯");
                await handlePartnerLeft();
                return;
            }

            await new Promise(r => setTimeout(r, 500));

            // åœ°åŒºç­›é€‰ï¼ˆå¯å¼€å…³ï¼‰
            const partnerInfo = document.querySelector("#partnerInfoText");
            // ä»…åœ¨æ¯ä¸ªå¥³ç”Ÿä¼šè¯é¦–æ¬¡è®¡æ•°
            const currentSessionId = getCurrentSessionId();
            if (currentSessionId && currentSessionId !== lastCountedFemaleSessionId) {
                statsFoundFemale++;
                lastCountedFemaleSessionId = currentSessionId;
            }
            if (isRegionFilterEnabled) {
                const partnerText = partnerInfo ? partnerInfo.innerText : "";
                const isTargetRegion = CURRENT_REGION_KEYWORDS.some(keyword => partnerText.includes(keyword));
                if (!partnerInfo || !isTargetRegion) {
                    // ä»…åœ¨æ¯ä¸ªå¥³ç”Ÿä¼šè¯é¦–æ¬¡è¢«ç­›æ‰æ—¶è®¡æ•°
                    if (currentSessionId && currentSessionId !== lastSkippedByRegionSessionId) {
                        statsSkippedByRegion++;
                        lastSkippedByRegionSessionId = currentSessionId;
                    }
                    console.log("å¯¹æ–¹ä¸æ˜¯ç›®æ ‡åœ°åŒºï¼Œè·³è¿‡é…å¯¹");
                    await handleMaleMatch(); // æŒ‰ç”·ç”Ÿå¤„ç†ï¼Œç¦»å¼€å½“å‰é…å¯¹
                    return;
                }
            }

            const msgInput = document.querySelector("#msgInput");
            const sendButton = document.querySelector("a.button-link.msg-send");
            // è·å–å½“å‰ä¼šè¯å”¯ä¸€æ ‡è¯†
            const sessionId = getCurrentSessionId();
            if (!sessionId || sessionId.trim() === "") {
                // å¯é€‰ï¼šconsole.log("ç­‰å¾…sessionIdåŠ è½½...");
                return;
            }

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨æ˜¯å¦å·²é—®å€™
            const greetedSession = localStorage.getItem("shushu_greeted_session");
            if (greetedSession === sessionId) {
                hasGreeted = true;
            } else {
                hasGreeted = false;
            }

            if (msgInput && sendButton && !hasGreeted) {
                // å¤šé‡é˜²æŠ–ï¼šè‹¥å·²æœ‰è‡ªå·±æ¶ˆæ¯ã€æ­£åœ¨é—®å€™ã€æˆ–èŠ‚æµæ—¶é—´æœªåˆ°ï¼Œåˆ™ä¸é—®å€™
                const myMsgs = document.querySelectorAll('.message.right');
                if (myMsgs && myMsgs.length > 0) {
                    return;
                }
                if (isGreetingInProgress) {
                    return;
                }
                const nowTs = Date.now();
                if (lastGreetingSessionId === sessionId && nowTs - lastGreetingAt < 8000) {
                    return;
                }
                isLocked = true;
                isGreetingInProgress = true;

                const greeting = getRandomGreeting();
                const typingSuccess = await simulateTyping(msgInput, greeting);

                if (hasNewSystemMessage()) {
                    isLocked = false;
                    await handlePartnerLeft();
                    return;
                }

                if (typingSuccess) {
                    sendButton.click();
                    matchCount++;
                    lastActionTime = Date.now();
                    hasGreeted = true;
                    lastSessionId = sessionId;
                    lastGreetingSessionId = sessionId;
                    lastGreetingAt = Date.now();
                    localStorage.setItem("shushu_greeted_session", sessionId); // è®°å½•å·²é—®å€™
                    console.log("æ¶ˆæ¯å·²å‘é€");
                }
            }
        } catch (error) {
            console.error("å¥³ç”ŸåŒ¹é…å¤„ç†å‡ºé”™:", error);
        } finally {
            // é‡ç½®é—®å€™è¿›è¡Œä¸­æ ‡è®°ï¼›ä»é€šè¿‡å·²å‘æ¶ˆæ¯ä¸ hasGreeted æ§åˆ¶åç»­è¡Œä¸º
            isGreetingInProgress = false;
            if (!document.querySelector(".message.right")) {
                isLocked = false;
            }
        }
    }

    async function startNewChat() {
        try {
            await new Promise(r => setTimeout(r, 500));

            const restartButton = document.querySelector("span.chat-control");
            if (restartButton && (restartButton.innerText === "é‡æ–°å¼€å§‹" || restartButton.innerText.includes("å¼€å§‹"))) {
                console.log("ç‚¹å‡»é‡æ–°å¼€å§‹æŒ‰é’®");
                await new Promise(r => setTimeout(r, getRandomDelay(200, 400)));
            isProgrammaticLeaveClick = true;
            restartButton.click();
            isProgrammaticLeaveClick = false;

                let retryCount = 0;
                const maxRetries = 3;

                while (retryCount < maxRetries) {
                    await new Promise(r => setTimeout(r, CONFIG.LEAVE_MIN_DELAY));

                    const secondCheck = document.querySelector("span.chat-control");
                    if (secondCheck && (secondCheck.innerText === "é‡æ–°å¼€å§‹" || secondCheck.innerText.includes("å¼€å§‹"))) {
                        console.log("é‡è¯•ç‚¹å‡»é‡æ–°å¼€å§‹");
                        isProgrammaticLeaveClick = true;
                        secondCheck.click();
                        isProgrammaticLeaveClick = false;
                    } else {
                        break;
                    }
                    retryCount++;
                }
            }
            isLocked = false;
            hasGreeted = false;
            lastSessionId = null;
            localStorage.removeItem("shushu_greeted_session");
            hasSecondReplied = false;
        } catch (error) {
            console.error("é‡æ–°å¼€å§‹å‡ºé”™:", error);
            isLocked = false;
        }
    }

    function getCurrentSessionId() {
        const partnerInfo = document.querySelector("#partnerInfoText");
        if (partnerInfo) {
            return partnerInfo.innerText.trim();
        }
        return null;
    }

    async function mainLoop() {
        if (!isScriptEnabled) return;

        try {
            if (Date.now() - lastActionTime < CONFIG.CHECK_INTERVAL) return;

            if (hasLeaveModal()) {
                await handleLeaveModal();
                await startNewChat();
                return;
            }

            // çº¯æ‰‹åŠ¨ä¼˜å…ˆï¼šæ£€æµ‹åˆ°å¯¹æ–¹ç¦»å¼€ä¹Ÿä¸è‡ªåŠ¨å¤„ç†ï¼Œäº¤ç”±é¢æ¿â€œé€€å‡ºâ€æ‰‹åŠ¨è§¦å‘

            if (isLocked) {
                return;
            }

            const partnerInfo = document.querySelector("#partnerInfoText");
            const partnerGender = partnerInfo ? partnerInfo.innerText : null;

            // å¦‚æœå…ƒç´ æœªåŠ è½½æˆ–å†…å®¹ä¸ºç©ºï¼Œå»¶è¿Ÿé‡è¯•ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (!partnerGender || partnerGender.trim() === "") {
                // å¯é€‰ï¼šconsole.log("ç­‰å¾…partnerInfoTextåŠ è½½...");
                return;
            }

            if (partnerGender.includes("ç”·ç”Ÿ")) {
                // ç”·ç”Ÿï¼šè‡ªåŠ¨ç¦»å¼€
                await handleMaleMatch();
            } else if (partnerGender.includes("å¥³ç”Ÿ")) {
                // å¥³ç”Ÿï¼šä¸è‡ªåŠ¨ç¦»å¼€ã€ä¸è‡ªåŠ¨é‡è¿ï¼Œæ”¹ä¸ºçº¯æ‰‹åŠ¨ï¼ˆé¢æ¿â€œé€€å‡ºâ€ï¼‰
                await handleFemaleMatch();
                // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨äºŒæ¬¡å›å¤
                await trySecondReply();
            }

        } catch (error) {
            console.error("ä¸»å¾ªç¯å‡ºé”™:", error);
            isLocked = false;
            isInLeaveProcess = false;
        }
    }

    async function trySecondReply() {
        if (hasSecondReplied) return;
        // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹æ–¹çš„æ¶ˆæ¯ï¼ˆå‡è®¾å·¦ä¾§æ¶ˆæ¯ class ä¸º .message.leftï¼‰
        const leftMsgs = document.querySelectorAll('.message.left');
        // åªåœ¨æœ‰å¯¹æ–¹æ¶ˆæ¯ä¸”è‡ªå·±è¿˜æ²¡äºŒæ¬¡å›å¤æ—¶è§¦å‘
        if (leftMsgs.length > 0) {
            // æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»å‘è¿‡ç¬¬äºŒå¥ï¼ˆé˜²æ­¢å¤šæ¬¡è§¦å‘ï¼‰
            const rightMsgs = document.querySelectorAll('.message.right');
            if (rightMsgs.length < 2) {
                const msgInput = document.querySelector("#msgInput");
                const sendButton = document.querySelector("a.button-link.msg-send");
                if (msgInput && sendButton) {
                    const reply = getRandomSecondReply();
                    // å¦‚æœè¾“å…¥æ¡†å†…å®¹å·²ç»æ˜¯è¦å‘çš„å†…å®¹ï¼Œç›´æ¥è¿”å›
                    if (msgInput.value === reply) return;
                    hasSecondReplied = true; // æå‰è®¾ç½®ï¼Œé˜²æ­¢å¹¶å‘
                    await simulateTyping(msgInput, reply);
                    sendButton.click();
                    // å¯é€‰ï¼šconsole.log("å·²è‡ªåŠ¨äºŒæ¬¡å›å¤");
                }
            }
        }
    }

    function init() {
        const statsDiv = createStatsDisplay();

        // è£…è½½ç¦»å¼€ä¿æŠ¤
        setupLeaveGuard();

        const runMainLoop = () => {
            mainLoop();
            updateStatsDisplay(statsDiv);
            setTimeout(runMainLoop, CONFIG.CHECK_INTERVAL + Math.random() * 200);
        };

        setTimeout(runMainLoop, getRandomDelay(1000, 1500));
    }

    setTimeout(init, getRandomDelay(1000, 1500));
})();
